#/bin/bash


echo "${GREEN}***************************************************************************************************************************************************${NC}"
echo "${GREEN}***************************************************************************************************************************************************${NC}"
echo ""
echo " ${ORANGE}${rocket} Kubernetes Workshop Series ${NC}"
echo ""
echo "${GREEN}***************************************************************************************************************************************************${NC}"
echo "${GREEN}***************************************************************************************************************************************************${NC}"
echo " ${CYAN}    Starting up your Minikube Training Environment $DO_NAM ${NC}"
echo "${GREEN}***************************************************************************************************************************************************${NC}"
echo "  "
echo "  "
echo "  "


echo "${GREEN}-----------------------------------------------------------------------------------------------------------------------------------${NC}"
echo " ${CYAN}    Starting up Docker $DO_NAM ${NC}"
docker start portainer

echo "${GREEN}-----------------------------------------------------------------------------------------------------------------------------------${NC}"
echo " ${CYAN}    Starting up your Minikube $DO_NAM ${NC}"
minikube start


echo "${GREEN}-----------------------------------------------------------------------------------------------------------------------------------${NC}"
echo " ${CYAN}    Creating Registry $DO_NAM ${NC}"
kubectl apply -f ./training/tools/kube-registry.yaml
kubectl port-forward --namespace kube-system $(kubectl get po -n kube-system | grep kube-registry-v0 | \awk '{print $1;}') 5000:5000  > /dev/null&

echo "${GREEN}-----------------------------------------------------------------------------------------------------------------------------------${NC}"
echo " ${CYAN}    Creating CNI Cilium $DO_NAM ${NC}"
kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.6/install/kubernetes/quick-install.yaml

echo "${GREEN}-----------------------------------------------------------------------------------------------------------------------------------${NC}"
echo " ${ORANGE}    Waiting 1 minute to start Kubernetes Dashboard $DO_NAM ${NC}"
sleep 60
minikube dashboard &

echo "${GREEN}-----------------------------------------------------------------------------------------------------------------------------------${NC}"
echo " ${CYAN}    Cleaning up $DO_NAM ${NC}"
kubectl get pods -n kube-system | grep -E "(Terminating|CrashLoopBackOff)" | awk '{print $1}' | xargs kubectl delete pod -n kube-system --force --grace-period=0


echo "${GREEN}***************************************************************************************************************************************************${NC}"
echo "${GREEN}***************************************************************************************************************************************************${NC}"
echo " ${GREEN}${healthy} Startup done....${NC}"
echo "${GREEN}***************************************************************************************************************************************************${NC}"
echo "${GREEN}***************************************************************************************************************************************************${NC}"
